function Ptype(e,t,r,a){this.content=e,this.jsEval=t,this.type=r,this.displayName=a}function clearQuery(){openCount=0,$("#queryTable tbody").children().remove(),$("#queryTable tfoot").children().first().next().remove(),limitUsed=!1,$("#protoDropdown li").remove(),buildDropdown()}function loadFromObj(e){var t=e.query;clearQuery();for(var r=[],a=0;a<t.length;a++)for(var o in t[a])if("undefined"!=typeof Ptypes[o]){var n=o.split("_");n=n[1],"undefined"!=typeof n&&"multiselect"==n&&$.each(t[a][o],function(e,t){var r=e.split("_");r=r[0],"undefined"!=typeof r&&"ms"==r&&multiDefaults.unshift.apply(multiDefaults,t.split(","))});var d=moveToQuery(o);if("undefined"!=typeof d)for(var p in t[a][o])"logical_op"==p?$(d).children().eq(logop_index).find("select").val(t[a][o][p]):($(d).find("[name='"+p+"'], [data-elem-name='"+p+"']").val(t[a][o][p]),$(d).find("[name='"+p+"'], [data-elem-name='"+p+"']").trigger("change"))}else if("bracket_open"==o){openCount+=1,r[r.length]=openCount;var d=addGroupingOpen(openCount);"undefined"!=typeof t[a][o].logical_op&&$(d).children().eq(logop_index).find("select").val(t[a][o].logical_op)}else"bracket_close"==o?(addGroupingClose(r[r.length-1]),r.pop()):console.log('ERROR: Prototype "'+o+'" does not exist');addDragEvents(),checkAllForLogOp()}function addDragEvents(){$(".dragHandle").bind("mousedown",function(){dragEnabled=!0,dragStartRow=$(this).parent().parent(),$("body").css("cursor","none"),$("button").css("cursor","none"),getGroupPairs(dragStartRow).addClass("queryform_highlight_row")}),$(".dragHandle").bind("mouseup",function(){dragEnabled=!1,$("body").css("cursor","auto"),$("button").css("cursor","auto")})}function getGroupPairs(e){return"undefined"==typeof e.attr("data-group-id")?e:$("[data-group-id='"+e.attr("data-group-id")+"']")}function buildNames(){$("#queryTable").find(":input").each(function(){var e=$(this);"undefined"!=typeof e.attr("name")&&"undefined"==typeof e.attr("data-elem-name")&&e.attr("data-elem-name",e.attr("name")),e.removeAttr("name")});var e=0;$("#queryTable tr").each(function(t){var r=this;if("undefined"!=typeof $(r).attr("data-row-type")){var a=$(r).attr("data-row-type");$(r).children().eq(logop_index).find("select").is(":visible")&&$(r).children().eq(logop_index).find("select").attr("name","form[query]["+e+"]["+a+"][logical_op]");var o=!1;$(r).children().eq(field_index).find(":input").each(function(){if("undefined"!=typeof $(this).attr("data-elem-name")){var t=$(this).attr("data-elem-name"),r=$(this).closest("[data-row-type]").attr("data-row-type");if("undefined"!=typeof Ptypes[r]){var a=Ptypes[r].placeholder,n=r.split("_");if(n=n[1],"undefined"!=typeof n&&"multiselect"==n)try{var d=JSON.parse($(this).attr("value")),p=[];for(var i in d)p.push(d[i].value);if(0==p.length)throw"no values";$(this).attr("value",p.join(","))}catch(l){"[]"==$(this).attr("value")&&$(this).attr("value","")}}"undefined"!=typeof a&&""!=a&&(t=t.replace(a+"_","")),o=!0,$(this).attr("name","form[query]["+e+"]["+r+"]["+t+"]")}}),o&&e++}})}function handleAddClick(e){moveToQuery(e)}function removeFromQuery(e){"bracket_open"==e.attr("data-row-type")?($("#queryTable tbody").find("[data-group-id='"+e.attr("data-group-id")+"']").remove(),openCount-=1):"randsubset_limitnumber"==e.attr("data-row-type")?(e.remove(),limitUsed=!1,buildDropdown()):e.remove(),checkAllForLogOp()}function moveUp(e){"bracket_close"==e.attr("data-row-type")?e.index()<$("[data-group-id='"+e.attr("data-group-id")+"'][data-row-type='bracket_open']").index()+2||e.insertBefore("undefined"==typeof e.prev().attr("data-group-id")?e.prev():$("[data-group-id='"+e.prev().attr("data-group-id")+"'][data-row-type='bracket_open']")):"bracket_open"==e.attr("data-row-type")?e.prev().insertAfter($("[data-group-id='"+e.attr("data-group-id")+"'][data-row-type='bracket_close']")):e.insertBefore(e.prev()),checkAllForLogOp()}function checkAllForLogOp(){$("#queryTable tbody tr").each(function(){var e=$(this);checkForLogOp(e)?e.children().eq(logop_index).find("select").show():e.children().eq(logop_index).find("select").hide()})}function moveDown(e){"bracket_open"==e.attr("data-row-type")?$("[data-group-id='"+e.attr("data-group-id")+"'][data-row-type='bracket_close']").next().insertBefore(e):"bracket_close"==e.attr("data-row-type")?"bracket_close"!=e.next().attr("data-row-type")&&"bracket_open"!=e.next().attr("data-row-type")?e.insertAfter(e.next()):"bracket_close"==e.next().attr("data-row-type")||e.insertAfter($("[data-group-id='"+e.next().attr("data-group-id")+"'][data-row-type='bracket_close']")):e.insertAfter(e.next()),checkAllForLogOp()}function moveToQuery(elementType){if("randsubset_limitnumber"==elementType){var tr=$.parseHTML('<tr data-row-type="'+elementType+'"><td>&nbsp;</td><td>&nbsp;</td><td>'+Ptypes[elementType].html+"</td></tr>");return $(tr).append(deletionPrototype),$("#queryTable > tfoot").append(tr),limitUsed=!0,buildDropdown(),tr}if("brackets"!=elementType){var tr=$.parseHTML('<tr data-row-type="'+elementType+'"><td>'+Ptypes[elementType].html+"</td></tr>");$(tr).find("*").each(function(){"undefined"!=typeof $(this).attr("id")&&$(this).attr("id",$(this).attr("id").replace(Ptypes[elementType].placeholder,"query_item_"+queryCount)),"undefined"!=typeof $(this).attr("class")&&$(this).attr("class",$(this).attr("class").replace(Ptypes[elementType].placeholder,"query_item_"+queryCount)),"undefined"!=typeof $(this).attr("name")&&$(this).attr("name",$(this).attr("name").replace(Ptypes[elementType].placeholder+"_",""))}),$(tr).append(deletionPrototype),$("#queryTable > tbody").append(tr);var logicalOpPrototypeCopy=$.parseHTML(logicalOpPrototype);checkForLogOp(tr)?$(logicalOpPrototypeCopy).prependTo(tr):$(logicalOpPrototypeCopy).prependTo(tr).children().hide(),$(tr).prepend(positionPrototype);var re=new RegExp(Ptypes[elementType].placeholder,"gi"),tmpJS=Ptypes[elementType].jsEval.replace(re,"query_item_"+queryCount),tmp=eval(tmpJS);return evaldCode["query_item_"+queryCount]=tmp,queryCount++,addDragEvents(),tr}addGrouping()}function buildDropdown(){$("#protoDropdown li").remove();for(var e in Ptypes){var t=$.parseHTML("<li><a>"+Ptypes[e].displayName+"</a></li>");$(t).attr("onclick","javascript:handleAddClick('"+Ptypes[e].type+"');"),limitUsed&&"randsubset_limitnumber"==e||$("#protoDropdown").append(t)}$("#addDropdown").dropit({action:"mouseenter",beforeShow:function(){}})}function checkForLogOp(e){var t=$(e).prev().attr("data-row-type");return"bracket_open"==t||"undefined"==typeof t?!1:"bracket_close"==$(e).attr("data-row-type")?!1:!0}function addGroupingOpen(e){"undefined"==typeof e&&(openCount+=1,e=openCount);var t=$.parseHTML('<tr data-group-id="'+e+'" data-row-type="bracket_open"><td>(<input type="hidden" data-elem-name="type" value="open"></td></tr>');return $("#queryTable tbody").append(t),checkForLogOp(t)?$(logicalOpPrototype).prependTo(t):$(logicalOpPrototype).prependTo(t).children().hide(),$(t).prepend(positionPrototypeOpenBracket),$(t).append(deletionPrototype),t}function addGroupingClose(e){"undefined"==typeof e&&(e=openCount);var t=$.parseHTML('<tr data-group-id="'+e+'" data-row-type="bracket_close"><td>)<input type="hidden" data-elem-name="type" value="close"></td></tr>');$("#queryTable tbody").append(t),$(t).prepend("<td>&nbsp;</td>"),$(t).prepend(positionPrototypeCloseBracket),$(t).append("<td>&nbsp;</td>")}function addGrouping(){addGroupingOpen(),addGroupingClose(),addDragEvents(),checkAllForLogOp()}var Ptypes={},queryCount=0,limitUsed=!1,multiDefaults=[],openCount=0,dragEnabled=!1,dragStartY=-1,dragStartRow=0,dragSensitivity=15,logicalOpPrototype='<td>&nbsp;<select><option value="and" selected>AND</option><option value="or">OR</option></select></td>',evaldCode={};$("html").mousemove(function(e){dragEnabled&&(-1==dragStartY&&(dragStartY=e.clientY),dragStartY-e.clientY>dragSensitivity?(dragStartY=e.clientY-dragSensitivity,moveUp(dragStartRow)):e.clientY-dragStartY>dragSensitivity&&(dragStartY=e.clientY+dragSensitivity,moveDown(dragStartRow)))}),$("html").mouseup(function(){dragEnabled=!1,$("body").css("cursor","auto"),$("button").css("cursor","auto"),0!=dragStartRow&&getGroupPairs(dragStartRow).removeClass("queryform_highlight_row"),dragEnabled&&(dragStartY=-1,dragStartRow=0)}),$(document).ready(function(){"use strict";buildDropdown(),$("#queryForm").submit(function(e){return e.preventDefault(),buildNames(),this.submit(),!1}),$("#savedDropdown").dropit({action:"mouseenter",beforeShow:function(){$("#savedDropdown .dropit-submenu").css("left","-371px"),$("#savedDropdown .dropit-submenu").css("width","600px")}}),"undefined"!=typeof jsonData&&loadFromObj(jsonData)});
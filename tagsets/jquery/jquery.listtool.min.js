function ListTool(t,e,o,i){this.formName=i,this.rows=t,this.dragEnabled=!1,this.dragStartY=-1,this.dragSensitivity=10;var n=this;this.elementSelector=e,this.buildDefaultList(),"undefined"!=typeof o&&null!==o&&(this.addButtonSelector=o),this.buildDropdown(),$("html").mousemove(function(t){n.handleMouseMove(t.clientY)}),$("html").on("mouseup",function(){n.handleMouseUp()}),$("html").on("touchend",function(){n.handleMouseUp()})}ListTool.prototype.getSortedRow=function(t){for(var e=0;e<this.rowsSorted.length;e++)if(this.rowsSorted[e].name==t)return{row:this.rows[t],sortedID:e}},ListTool.prototype.sortRows=function(){function t(t){for(var e=-1,i=0;i<o.length;i++)if(!(t.fixed_position<0&&1==o[i].positivePos||t.fixed_position>=0&&0==o[i].positivePos||0==t.drag&&1==o[i].drag||1==t.drag&&0==o[i].drag)){e=i;break}return e}var e=[];$.each(this.rows,function(t,o){e.push({name:t,fixed_position:o.fixed_position,drag:o.allow_drag,"delete":o.allow_remove})}),e.sort(function(t,e){if(t.fixed_position<0&&e.fixed_position<0){if(t.fixed_position>e.fixed_position)return 1}else if(t.fixed_position>0&&e.fixed_position>0){if(t.fixed_position>e.fixed_position)return 1}else if(t.fixed_position<e.fixed_position)return 1;return-1});for(var o=[{drag:!1,positivePos:!0},{drag:!0,positivePos:!0},{drag:!0,positivePos:!1},{drag:!1,positivePos:!1}],i=[],n=0;n<o.length;n++)for(var r=0;r<e.length;r++)t(e[r])==n&&i.push(e[r]);return i},ListTool.prototype.buildDefaultList=function(){this.rowsSorted=this.sortRows();for(var t=0;t<this.rowsSorted.length;t++)this.rows[this.rowsSorted[t].name].on_list&&this.addRow(this.rowsSorted[t].name,!0)},ListTool.prototype.buildDropdown=function(){if("undefined"!=typeof this.addButtonSelector){var t=this;this.addButtonSelector.find(".dropdownItems").children().remove();var e=0;$.each(this.rows,function(o,i){if(1>t.elementSelector.find("[data-instance='"+o+"']").length){var n=$.parseHTML("<li><a>"+i.display_text+"</a></li>");$(n).on("click",function(){t.handleAddClick(o)}),t.addButtonSelector.find(".dropdownItems").append(n),e++}}),1>e?this.addButtonSelector.find(".button").attr("disabled","disabled"):this.addButtonSelector.find(".button").removeAttr("disabled"),this.addButtonSelector.dropit({action:"mouseenter",beforeShow:function(){}})}},ListTool.prototype.handleAddClick=function(t){this.addRow(t),this.buildDropdown()},ListTool.prototype.handleDeleteClick=function(t){t.remove(),this.buildDropdown()},ListTool.prototype.handleMoveMouseDown=function(t){this.dragRow=t,this.dragEnabled=!0,$("body, html").css("cursor","none"),$("button").css("cursor","none"),$(this.dragRow).addClass("highlight_row")},ListTool.prototype.handleMouseMove=function(t){this.dragEnabled&&(-1==this.dragStartY&&(this.dragStartY=t),this.dragStartY-t>this.dragSensitivity?(this.dragStartY=t-this.dragSensitivity,this.moveRow("up",this.dragRow)):t-this.dragStartY>this.dragSensitivity&&(this.dragStartY=t+this.dragSensitivity,this.moveRow("down",this.dragRow)))},ListTool.prototype.handleMouseUp=function(){this.dragEnabled=!1,this.dragStartY=-1,$("body, html").css("cursor","auto"),$("button").css("cursor","auto"),"undefined"!=typeof this.dragRow&&$(this.dragRow).removeClass("highlight_row")},ListTool.prototype.moveRow=function(t,e){"up"==t?1==e.prev().length&&this.rows[e.prev().attr("data-instance")].allow_drag&&e.insertBefore(e.prev()):1==e.next().length&&this.rows[e.next().attr("data-instance")].allow_drag&&e.insertAfter(e.next())},ListTool.prototype.addRow=function(t,e){"undefined"==typeof e&&(e=!1);var o=this,i=this.rows[t],n="",r='<tr data-instance="'+t+'"><td>'+n+'<input type="hidden" name="'+this.formName+'[]" value="'+t+'" /></td>'+i.cols;r+="<td></td></tr>";var s=$.parseHTML(r);if(i.allow_drag){var d=$.parseHTML('<button class="fa-bars dragHandle" style="font-family: FontAwesome; height: 2em; width: 2em; font-size: 1em; cursor: auto;" onclick="return false;"></button>');$(d).on("mousedown",function(){o.handleMoveMouseDown($(this).parent().parent())}),$(d).on("touchstart",function(){o.handleMoveMouseDown($(this).parent().parent())}),$(d).on("touchmove",function(t){1==t.originalEvent.targetTouches.length&&o.handleMouseMove(t.originalEvent.targetTouches[0].clientY),t.preventDefault()}),$(s).children().first().append(d)}if(i.allow_remove){var a=$.parseHTML('<i class="fa fa-times-circle" style="color: red;"></i>');$(a).on("click",function(){o.handleDeleteClick($(this).parent().parent())}),$(s).children().last().append(a)}if(e||$(this.elementSelector).find("[data-instance]").length<1)this.elementSelector.find("tbody").append(s);else if(1==$(this.elementSelector).find("[data-instance]").length){var l=$(this.elementSelector).find("tbody").children().first();o.getSortedRow(l.attr("data-instance")).sortedID>o.getSortedRow(t).sortedID?$(s).insertBefore(l):$(s).insertAfter(l)}else{var h=o.rowsSorted.length-1,f=o.rowsSorted.length-1;$.each($(this.elementSelector.find("tbody tr")),function(e,i){var n=$(i).attr("data-instance");Math.abs(o.getSortedRow(n).sortedID-o.getSortedRow(t).sortedID)<=Math.abs(h)&&(f=o.getSortedRow(n).sortedID,h=o.getSortedRow(n).sortedID-o.getSortedRow(t).sortedID)});var u=$(this.elementSelector).find("[data-instance='"+o.rowsSorted[f].name+"']");h>0?$(s).insertBefore(u):$(s).insertAfter(u)}};